{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% block title %}Dashboard{% endblock title %}
{% block content %}
<div class="col-12 col-lg-10 px-4 mx-auto px-3 px-lg-4 pt-2">
    <div style="min-height: 60px;"></div>
    <div style="background: #f0f6ff; border-radius: 20px; width: 100%; max-width: 1350px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); overflow: hidden; font-family: Inter; margin: auto;">
        
        <!-- Header do Card -->
        <div class="d-flex align-items-center" style="background: #2563EB; padding: 25px 30px; border-bottom: 1px solid #f0f0f0; justify-content: space-between;">
            <h2 style="color: white; font-size: 30px; font-weight: 700; margin: 0;">Visão Geral</h2>
        </div>
        <div class="p-4">
            <div class="row g-3">

                <!-- Faturamento -->
                <div class="col-12 col-md-4">
                    <div class="bg-white shadow-sm d-flex align-items-center p-3 h-100"
                        style="border-radius: 12px; font-family: Inter;">
                        <div class="me-3 p-3 d-flex align-items-center justify-content-center"style="width: 80px; height: 80px; background-color: #DBEAFE;border-radius: 12px;">
                            <i class="fa-solid fa-dollar-sign" style="font-size: 40px; color: #2563EB;"></i>
                        </div>

                        <div>
                            <span style="font-size: 16px; font-weight: 600;">
                                Faturamento
                            </span>
                            <h2 style="font-weight: 700; margin: 0;">R$ {{ faturamento|floatformat:2 }}</h2>
                        </div>
                    </div>
                </div>
                <!-- Produtos -->
                <div class="col-12 col-md-4">
                    <div class="bg-white shadow-sm d-flex align-items-center p-3 h-100"
                        style="border-radius: 12px; font-family: Inter;">
                        <div class="me-3 p-3"
                            style="width: 80px; height: 80px; background-color: #DBEAFE; border-radius: 12px; display:flex; justify-content:center; align-items:center;">
                            <i class="fa-solid fa-cube" 
                            style="font-size: 40px; color: #2563EB;"></i>
                        </div>

                        <div>
                            <span style="font-size: 16px; font-weight: 600;">
                                Produtos Cadastrados
                            </span>
                            <h2 style="font-weight: 700; margin: 0;">{{ total_produtos }}</h2>
                        </div>
                    </div>
                </div>
                <!-- Clientes -->
                <div class="col-12 col-md-4">
                    <div class="bg-white shadow-sm d-flex align-items-center p-3 h-100"
                        style="border-radius: 12px; font-family: Inter;">
                        <div class="me-3 p-3" 
                            style="width: 80px; height: 80px; background-color: #DBEAFE; border-radius: 12px; display:flex; justify-content:center; align-items:center;">
                            <i class="fa-solid fa-user" 
                            style="font-size: 40px; color: #2563EB;"></i>
                        </div>

                        <div>
                            <span style="font-size: 16px; font-weight: 600;">
                                Clientes Cadastrados
                            </span>
                            <h2 style="font-weight: 700; margin: 0;">{{ total_clientes }}</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4 g-3">
            <div class="col-12 col-lg-6">
                <div class="bg-white shadow-sm" style="height: 450px; border-radius: 12px;">
                    <div class="d-flex align-items-center" style="background: white; padding: 5px 10px; border-bottom: 1px solid #f0f0f0; justify-content: space-between; border-top-left-radius: 12px; border-top-right-radius: 12px;">
                        <h2 style="color: white; font-size: 14px; font-weight: 700; margin: 0; color: black;">Faturamento mensal:</h2>
                    </div>
                    <div style="padding: 15px; height: 420px;">
                        <canvas id="graficoFaturamento" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="bg-white shadow-sm" style="height: 450px; border-radius: 12px; font-family: Inter;">
                    <div class="d-flex align-items-center" style="background: white; padding: 5px 10px; border-bottom: 1px solid #f0f0f0; justify-content: space-between; border-top-left-radius: 12px; border-top-right-radius: 12px;">
                        <h2 style="color: white; font-size: 14px; font-weight: 700; margin: 0; color: black;">Quantidade de Vendas: (últimas 4 semanas)</h2>
                    </div>
                    <div style="padding: 15px; height: 420px;">
                        <canvas id="vendasChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>            
    </div>
</div>

{% endblock content %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var labels = {{ labels_json|safe }};
    var dados = {{ vendas_json|safe }};

    var maxValor = Math.max.apply(null, dados);
    var minValor = Math.min.apply(null, dados);

    // Se a diferença for pequena, começa do zero
    var usarZero = (maxValor - minValor) <= 5;

    var ctx = document.getElementById('vendasChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Vendas concluídas',
                data: dados,
                backgroundColor: '#2563EB',
                borderRadius: 6,        
                minBarLength: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: false },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: usarZero,
                        min: usarZero ? 0 : Math.max(minValor - 1, 0),
                        max: maxValor + 2, 
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : null;
                        }
                    }
                }]
            }
        }
    });
    
    // Gráfico de faturamento
    const faturamentoCtx = document.getElementById('graficoFaturamento');
    if (faturamentoCtx) {
        new Chart(faturamentoCtx, {
            type: 'line',
            data: {
                labels: {{ labels_faturamento_json|safe }},
                datasets: [{
                    label: 'Faturamento Mensal (R$)',
                    data: {{ faturamento_json|safe }},
                    borderColor: '#2563EB',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
});
</script>
{% endblock scripts %}